<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Kewangan Masjid</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background-color: #2c3e50; color: white; }
        .sidebar .nav-link { color: rgba(255,255,255,0.85); cursor: pointer; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: all 0.3s; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #34495e; transform: translateX(5px); }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background-color: white; border-bottom: 1px solid #eee; font-weight: bold; padding: 15px 20px; }
        .login-logo { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 3px solid #fff; }
        .sidebar-logo { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); margin-bottom: 10px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #loginSection { min-height: 100vh; }
        .d-none-custom { display: none !important; }
        canvas { max-height: 300px; }

        @media print {
            .no-print, .sidebar, #loginSection, .btn, .modal { display: none !important; }
            .col-md-9, .col-lg-10 { width: 100% !important; flex: 0 0 100%; max-width: 100%; padding: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            body { background-color: white; }
            #printArea { display: block; }
            .table th, .table td { padding: 4px !important; font-size: 9px; } 
        }
        #reportTable th { font-size: 12px; vertical-align: middle; }
        #reportTable td { font-size: 13px; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3 fw-bold text-secondary">Sedang memproses...</p>
    </div>

    <section id="loginSection" class="container d-flex align-items-center justify-content-center">
        <div class="card p-5" style="max-width: 450px; width: 100%;">
            <div class="text-center mb-4">
                <img src="https://i.imgur.com/1mYHNYA.jpeg" alt="Logo Masjid" class="login-logo">
                <h3 class="fw-bold">Sistem Kewangan</h3>
                <p class="text-muted">Log Masuk Diperlukan</p>
            </div>
            <div class="form-floating mb-3">
                <input type="text" id="username" class="form-control" placeholder="Username">
                <label>Nama Pengguna</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" id="password" class="form-control" placeholder="Password">
                <label>Kata Laluan</label>
            </div>
            <button onclick="handleLogin()" class="btn btn-success w-100 py-2 fs-5 fw-bold">Log Masuk</button>
            <small class="text-muted text-center d-block mt-3" id="firebaseStatus">Status Database: Realtime DB Active</small>
        </div>
    </section>

    <div id="mainApp" class="container-fluid d-none-custom" style="display: none;">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar p-3 no-print">
                <div class="text-center mb-4 pt-2">
                    <img src="https://i.imgur.com/1mYHNYA.jpeg" alt="Logo Admin" class="sidebar-logo">
                    <h5 class="mt-2">Panel Admin</h5>
                    <hr class="text-light">
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" onclick="switchView('dashboard')">
                            <i class="fas fa-home me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="switchView('rekod')">
                            <i class="fas fa-file-invoice-dollar me-2"></i> Rekod Kewangan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="switchView('laporan')">
                            <i class="fas fa-print me-2"></i> Laporan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="switchView('profil')">
                            <i class="fas fa-university me-2"></i> Profil
                        </a>
                    </li>
                    <li class="nav-item mt-auto pt-5">
                        <a class="nav-link text-warning" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt me-2"></i> Log Keluar
                        </a>
                    </li>
                </ul>
            </div>

            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                    <h2 id="pageTitle" class="fw-bold text-dark">Dashboard</h2>
                    <div class="text-end">
                        <small class="text-muted d-block">Tarikh Hari Ini</small>
                        <span id="currentDate" class="fw-bold text-primary"></span>
                    </div>
                </div>

                <div id="view-dashboard" class="content-view">
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="card bg-primary text-white h-100 shadow">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase mb-2 opacity-75">Baki Tunai</h6>
                                            <h2 class="display-6 fw-bold mb-0" id="balTunai">RM 0.00</h2>
                                        </div>
                                        <i class="fas fa-wallet fa-3x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-success text-white h-100 shadow">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase mb-2 opacity-75">Baki Bank</h6>
                                            <h2 class="display-6 fw-bold mb-0" id="balBank">RM 0.00</h2>
                                        </div>
                                        <i class="fas fa-university fa-3x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-line me-2"></i>Prestasi Tahunan <span id="chartYearLabel"></span></h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartPerformance"></canvas>
                                </div>
                            </div>
                        </div>
                
                        <div class="col-lg-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Pecahan Kategori</h6>
                                    <button class="btn btn-sm btn-outline-danger" onclick="generateMonthlySummaryPDF()" title="Jana PDF Ringkasan Dashboard">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs nav-fill mb-3" id="chartTabs" role="tablist">
                                        <li class="nav-item">
                                            <button class="nav-link active small py-1" data-bs-toggle="tab" data-bs-target="#tabMasuk">Masuk</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link small py-1" data-bs-toggle="tab" data-bs-target="#tabKeluar">Keluar</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane fade show active" id="tabMasuk">
                                            <div class="d-flex justify-content-center">
                                                <canvas id="chartIncomePie" style="max-height: 250px;"></canvas>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="tabKeluar">
                                            <div class="d-flex justify-content-center">
                                                <canvas id="chartExpensePie" style="max-height: 250px;"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-rekod" class="content-view d-none">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-muted">Tahun</label>
                                    <select id="filterYear" class="form-select"></select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-muted">Bulan</label>
                                    <select id="filterMonth" class="form-select">
                                        <option value="all">Semua Bulan</option>
                                        <option value="0">Januari</option>
                                        <option value="1">Februari</option>
                                        <option value="2">Mac</option>
                                        <option value="3">April</option>
                                        <option value="4">Mei</option>
                                        <option value="5">Jun</option>
                                        <option value="6">Julai</option>
                                        <option value="7">Ogos</option>
                                        <option value="8">September</option>
                                        <option value="9">Oktober</option>
                                        <option value="10">November</option>
                                        <option value="11">Disember</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="loadData()">
                                        <i class="fas fa-filter me-2"></i> Tapis Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success mb-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalTambah">
                        <i class="fas fa-plus-circle me-2"></i> Tambah Transaksi
                    </button>

                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0 align-middle" id="tableRecords">
                                    <thead class="table-dark text-center">
                                        <tr>
                                            <th rowspan="2" class="align-middle">Tarikh</th>
                                            <th rowspan="2" class="align-middle">Butiran</th>
                                            <th rowspan="2" class="align-middle">Dokumen</th>
                                            <th colspan="2">Masuk</th>
                                            <th colspan="2">Keluar</th>
                                            <th colspan="3">Baki</th>
                                            <th rowspan="2" class="align-middle">Aksi</th>
                                        </tr>
                                        <tr>
                                            <th>Tunai</th>
                                            <th>Bank</th>
                                            <th>Tunai</th>
                                            <th>Bank</th>
                                            <th>Tunai</th>
                                            <th>Bank</th>
                                            <th>Jum</th>
                                        </tr>
                                    </thead>
                                    <tbody class="border-top-0"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-laporan" class="content-view d-none">
                    <div class="card mb-4 no-print">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">Cetak Laporan</h5>
                                <small class="text-muted">Ikut tapisan 'Rekod'.</small>
                            </div>
                            <button class="btn btn-danger" onclick="generatePDF()">
                                <i class="fas fa-file-pdf me-2"></i> Muat Turun PDF
                            </button>
                        </div>
                    </div>

                    <div id="printArea" class="bg-white p-4 border shadow-sm">
                        <div class="mb-4">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label class="fw-bold m-0">Nama Masjid:</label>
                                    <div>Masjid Mukim Kuala Gris</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold m-0">No Akaun:</label>
                                    <div id="reportAccNoText">-</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold m-0">Nama Bank:</label>
                                    <div id="reportBankNameText">-</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="fw-bold m-0">Daerah:</label>
                                    <div>Dabong</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold m-0">Negeri:</label>
                                    <div>Kelantan</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold m-0">Bulan/Tahun:</label>
                                    <div id="reportPeriodText"></div>
                                </div>
                            </div>
                            <hr>
                            <h4 class="text-center fw-bold mt-3">LAPORAN KEWANGAN</h4>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered border-dark table-sm" id="reportTable">
                                <thead class="bg-light text-center align-middle">
                                    <tr>
                                        <th rowspan="2" style="width:3%">Bil</th>
                                        <th rowspan="2" style="width:8%">Tarikh</th>
                                        <th rowspan="2">Butir-Butir</th>
                                        <th rowspan="2" style="width:8%">No.Cek</th>
                                        <th rowspan="2" style="width:8%">No.Resit</th>
                                        <th rowspan="2" style="width:8%">No.Baucer</th>
                                        <th colspan="2">Penerimaan</th>
                                        <th colspan="2">Pembayaran</th>
                                        <th colspan="3">Baki</th>
                                    </tr>
                                    <tr>
                                        <th>Tunai</th>
                                        <th>Bank</th>
                                        <th>Tunai</th>
                                        <th>Bank</th>
                                        <th>Tunai</th>
                                        <th>Bank</th>
                                        <th class="bg-light">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody"></tbody>
                                <tfoot class="fw-bold bg-light">
                                    <tr>
                                        <td colspan="6" class="text-end text-uppercase">Baki Akhir</td>
                                        <td class="text-end" id="reportTotalInCash">0.00</td>
                                        <td class="text-end" id="reportTotalInBank">0.00</td>
                                        <td class="text-end" id="reportTotalOutCash">0.00</td>
                                        <td class="text-end" id="reportTotalOutBank">0.00</td>
                                        <td class="text-end" id="reportFinalCash">0.00</td>
                                        <td class="text-end" id="reportFinalBank">0.00</td>
                                        <td class="text-end" id="reportFinalTotal">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="row mt-5 pt-4">
                            <div class="col-4 text-center">
                                <p>Disediakan Oleh,</p>
                                <br><br>
                                <p>.......................................<br>(Bendahari)</p>
                            </div>
                            <div class="col-4"></div>
                            <div class="col-4 text-center">
                                <p>Disahkan Oleh,</p>
                                <br><br>
                                <p>.......................................<br>(Pengerusi)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-profil" class="content-view d-none">
                    <div class="card mb-4">
                        <div class="card-header"><i class="fas fa-university me-2"></i> Tetapan Masjid</div>
                        <div class="card-body p-4">
                            <form id="formProfil">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Nama Bank</label>
                                    <input type="text" id="profBankName" class="form-control" placeholder="Nama Bank">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">No Akaun</label>
                                    <input type="text" id="profAccNo" class="form-control" placeholder="No Akaun">
                                </div>
                                <button type="button" onclick="saveProfile()" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-2"></i> Simpan
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-users-cog me-2"></i> Pengurusan Admin (Firebase)
                        </div>
                        <div class="card-body p-4">
                            <div class="alert alert-warning small">
                                <i class="fas fa-info-circle me-1"></i> Pengurusan admin kini melalui Realtime Database.
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <input type="text" id="newAdminUser" class="form-control" placeholder="Username Baru">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" id="newAdminPass" class="form-control" placeholder="Password Baru">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-info text-white w-100" onclick="addAdminFirebase()">Tambah</button>
                                </div>
                            </div>
                            <hr>
                            <h6 class="fw-bold mb-3">Senarai Admin</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Username</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <i class="fas fa-exclamation-triangle me-2"></i> Reset Data
                        </div>
                        <div class="card-body p-4">
                            <p class="text-muted">Padam SEMUA rekod.</p>
                            <button class="btn btn-outline-danger" onclick="resetDatabase()">
                                <i class="fas fa-trash me-2"></i> Reset Sistem
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalTambah" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Tambah Transaksi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formAddTransaction">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="fw-bold">Jenis</label>
                                <select id="tType" class="form-select">
                                    <option value="Penerimaan">Penerimaan (Masuk)</option>
                                    <option value="Pengeluaran">Pengeluaran (Keluar)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold">Tarikh</label>
                                <input type="date" id="tDate" class="form-control">
                            </div>
                        </div>
                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="small text-muted">Nama Pembayar/Penerima</label>
                                    <input type="text" id="tPartyName" class="form-control">
                                </div>
                                <div>
                                    <label class="small text-muted">Alamat</label>
                                    <textarea id="tPartyAddress" class="form-control" rows="1"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Butiran</label>
                            <input type="text" id="tDesc" class="form-control">
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="small fw-bold">Jenis Dok.</label>
                                <select id="tDocType" class="form-select form-select-sm">
                                    <option value="Resit">Resit</option>
                                    <option value="Baucer">Baucer</option>
                                    <option value="Cek">Cek</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="small fw-bold">No. Dokumen.</label>
                                <input type="text" id="tDocNo" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-4">
                                <label class="small fw-bold">Fail</label>
                                <input type="file" id="tDocFile" class="form-control form-control-sm">
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Tunai RM</span>
                                    <input type="number" step="0.01" id="tAmountCash" class="form-control" value="0.00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Bank RM</span>
                                    <input type="number" step="0.01" id="tAmountBank" class="form-control" value="0.00">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" onclick="submitTransaction()" class="btn btn-success">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEdit" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Kemaskini Transaksi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formEditTransaction">
                        <input type="hidden" id="editTrxId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="fw-bold">Jenis</label>
                                <select id="eType" class="form-select">
                                    <option value="Penerimaan">Penerimaan (Masuk)</option>
                                    <option value="Pengeluaran">Pengeluaran (Keluar)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold">Tarikh</label>
                                <input type="date" id="eDate" class="form-control">
                            </div>
                        </div>
                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="small text-muted">Nama Pembayar/Penerima</label>
                                    <input type="text" id="ePartyName" class="form-control">
                                </div>
                                <div>
                                    <label class="small text-muted">Alamat</label>
                                    <textarea id="ePartyAddress" class="form-control" rows="1"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Butiran</label>
                            <input type="text" id="eDesc" class="form-control">
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="small fw-bold">Jenis Dok.</label>
                                <select id="eDocType" class="form-select form-select-sm">
                                    <option value="Resit">Resit</option>
                                    <option value="Baucer">Baucer</option>
                                    <option value="Cek">Cek</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="small fw-bold">No. Dokumen.</label>
                                <input type="text" id="eDocNo" class="form-control form-control-sm">
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Tunai RM</span>
                                    <input type="number" step="0.01" id="eAmountCash" class="form-control" value="0.00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">Bank RM</span>
                                    <input type="number" step="0.01" id="eAmountBank" class="form-control" value="0.00">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" onclick="submitUpdate()" class="btn btn-primary">Kemaskini</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalUpload" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Kemaskini Lampiran</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="uploadTrxId">
                    <label class="form-label fw-bold">Pilih Fail Baru</label>
                    <input type="file" id="newDocFile" class="form-control mt-2">
                    <div class="alert alert-info mt-3 small">
                        <i class="fas fa-info-circle me-1"></i> Fail baru ini akan menggantikan fail lama (jika ada).
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="saveAttachment()">Muat Naik & Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        let transactionsData = [];
        let cumulativeBalanceCache = {};
        let myChartPerformance = null, myChartIncome = null, myChartExpense = null;

        document.addEventListener('DOMContentLoaded', () => {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ms-MY', options);
            
            const yearSelect = document.getElementById('filterYear');
            const currentYear = new Date().getFullYear();
            for(let i = currentYear; i >= currentYear - 5; i--) {
                let opt = document.createElement('option');
                opt.value = i; opt.text = i; yearSelect.appendChild(opt);
            }
            document.getElementById('tDate').valueAsDate = new Date();
        });

        // --- AUTH ---
        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            toggleLoading(true);
            if(u === 'admin' && p === 'admin123') { proceedLogin(); return; }
            google.script.run.withSuccessHandler((admins) => {
                const found = admins.find(a => a.username === u && a.password === p);
                if (found) proceedLogin();
                else { alert("Salah username/password!"); toggleLoading(false); }
            }).getAdminsFromFirebase();
        }

        function proceedLogin() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('loginSection').classList.remove('d-flex');
            const app = document.getElementById('mainApp');
            app.style.display = 'block'; app.classList.remove('d-none-custom');
            loadData(); loadProfile(); loadAdminsFirebase(); toggleLoading(false);
        }

        function handleLogout() {
            document.getElementById('mainApp').style.display = 'none';
            const login = document.getElementById('loginSection');
            login.style.display = 'flex'; login.classList.add('d-flex');
            document.getElementById('username').value = ''; document.getElementById('password').value = '';
            switchView('dashboard');
        }

        function loadAdminsFirebase() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '<tr><td colspan="2" class="text-center">Loading...</td></tr>';
            google.script.run.withSuccessHandler((admins) => {
                tbody.innerHTML = '';
                if(!admins || admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Tiada admin tambahan.</td></tr>';
                    return;
                }
                admins.forEach((admin) => {
                    tbody.innerHTML += `<tr><td>${admin.username}</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="deleteAdminFirebase('${admin.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            }).getAdminsFromFirebase();
        }

        function addAdminFirebase() {
            const u = document.getElementById('newAdminUser').value, p = document.getElementById('newAdminPass').value;
            if(!u || !p) { alert("Sila isi username dan password"); return; }
            toggleLoading(true);
            google.script.run.withSuccessHandler((res) => {
                alert(res); document.getElementById('newAdminUser').value = ''; document.getElementById('newAdminPass').value = '';
                loadAdminsFirebase(); toggleLoading(false);
            }).addAdminToFirebase({ username: u, password: p });
        }

        function deleteAdminFirebase(id) { if(!confirm("Padam admin ini?")) return; toggleLoading(true); google.script.run.withSuccessHandler(() => { loadAdminsFirebase(); toggleLoading(false); }).deleteAdminFromFirebase(id); }

        function switchView(viewName) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.add('d-none'));
            document.getElementById(`view-${viewName}`).classList.remove('d-none');
            const titles = {'dashboard': 'Dashboard', 'rekod': 'Rekod', 'laporan': 'Laporan', 'profil': 'Profil'};
            document.getElementById('pageTitle').innerText = titles[viewName];
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => { if(link.getAttribute('onclick').includes(viewName)) link.classList.add('active'); });
        }

        function toggleLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        // --- DATA ---
        function loadData() {
            toggleLoading(true);
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler((err) => {
                toggleLoading(false);
                alert("Gagal memuatkan data: " + err.message);
            }).getTransactions();

            function onDataLoaded(data) {
                transactionsData = data.sort((a, b) => new Date(a.tarikh) - new Date(b.tarikh));
                let finalCash = 0, finalBank = 0;
                cumulativeBalanceCache = {};
                transactionsData.forEach(item => {
                    const cash = parseFloat(item.jumlah_tunai || 0), bank = parseFloat(item.jumlah_bank || 0);
                    if (item.jenis === 'Penerimaan') { finalCash += cash; finalBank += bank; }
                    else { finalCash -= cash; finalBank -= bank; }
                    cumulativeBalanceCache[item.id] = { cash: finalCash, bank: finalBank };
                });
                document.getElementById('balTunai').innerText = "RM " + formatMoney(finalCash);
                document.getElementById('balBank').innerText = "RM " + formatMoney(finalBank);
                let filteredData = transactionsData.filter(item => {
                    let d = new Date(item.tarikh);
                    return d.getFullYear() == year && (month === 'all' ? true : d.getMonth() == month);
                });
                renderTable(filteredData); renderReport(filteredData); renderDashboardCharts(transactionsData, year); toggleLoading(false);
            }
        }

        function renderDashboardCharts(allData, selectedYear) {
            document.getElementById('chartYearLabel').innerText = `(${selectedYear})`;
            const yearData = allData.filter(d => new Date(d.tarikh).getFullYear() == selectedYear);
            let monthlyIn = new Array(12).fill(0), monthlyOut = new Array(12).fill(0), catIn = {}, catOut = {}; 
            yearData.forEach(item => {
                const monthIdx = new Date(item.tarikh).getMonth();
                const amount = parseFloat(item.jumlah_tunai || 0) + parseFloat(item.jumlah_bank || 0);
                let category = (item.butiran || "Lain-lain").split(' ').slice(0, 3).join(' '); 
                if(item.jenis === 'Penerimaan') { monthlyIn[monthIdx] += amount; catIn[category] = (catIn[category] || 0) + amount; }
                else { monthlyOut[monthIdx] += amount; catOut[category] = (catOut[category] || 0) + amount; }
            });
            const ctxPerf = document.getElementById('chartPerformance').getContext('2d');
            if(myChartPerformance) myChartPerformance.destroy();
            myChartPerformance = new Chart(ctxPerf, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogos', 'Sep', 'Okt', 'Nov', 'Dis'],
                    datasets: [
                        { label: 'Masuk (RM)', data: monthlyIn, backgroundColor: 'rgba(25, 135, 84, 0.7)', borderColor: '#198754', borderWidth: 1, borderRadius: 3 },
                        { label: 'Keluar (RM)', data: monthlyOut, backgroundColor: 'rgba(220, 53, 69, 0.7)', borderColor: '#dc3545', borderWidth: 1, borderRadius: 3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
            renderPie(document.getElementById('chartIncomePie'), catIn, 'myChartIncome'); renderPie(document.getElementById('chartExpensePie'), catOut, 'myChartExpense');
        }

        function renderPie(canvasParam, dataObj, chartVarName) {
            const ctx = canvasParam.getContext('2d');
            let entries = Object.entries(dataObj).sort((a,b) => b[1] - a[1]);
            if(entries.length > 6) {
                const top5 = entries.slice(0, 5); const others = entries.slice(5).reduce((acc, curr) => acc + curr[1], 0);
                entries = [...top5, ['Lain-lain', others]];
            }
            const labels = entries.map(e => e[0]), values = entries.map(e => e[1]);
            if(chartVarName === 'myChartIncome' && myChartIncome) myChartIncome.destroy();
            if(chartVarName === 'myChartExpense' && myChartExpense) myChartExpense.destroy();
            const newChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length ? labels : ['Tiada Data'],
                    datasets: [{ data: values.length ? values : [1], backgroundColor: values.length ? ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'] : ['#e3e6f0'], hoverOffset: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });
            if(chartVarName === 'myChartIncome') myChartIncome = newChart; if(chartVarName === 'myChartExpense') myChartExpense = newChart;
        }

        function renderTable(data) {
            const tbody = document.querySelector('#tableRecords tbody'); tbody.innerHTML = '';
            if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="12" class="text-center py-4 text-muted">Tiada rekod.</td></tr>`; return; }
            data.forEach(item => {
                const isInc = item.jenis === 'Penerimaan', bal = cumulativeBalanceCache[item.id] || { cash: 0, bank: 0 };
                const fileBtn = item.fail_url ? `<a href="${item.fail_url}" target="_blank" class="btn btn-sm btn-outline-success"><i class="fas fa-paperclip"></i></a>` : '';
                tbody.innerHTML += `<tr class="text-end"><td class="text-start text-nowrap">${formatDate(item.tarikh)}</td><td class="text-start"><div class="fw-bold">${item.penerima_pembayar}</div><span class="small text-muted">${item.butiran || ''}</span></td><td class="text-center small text-nowrap"><div class="mb-1">${item.no_dokumen || '-'}</div><div>${fileBtn} <button class="btn btn-sm btn-link text-secondary" onclick="openUploadModal('${item.id}')"><i class="fas fa-cloud-upload-alt"></i></button></div></td><td>${isInc?formatMoney(item.jumlah_tunai):'-'}</td><td>${isInc?formatMoney(item.jumlah_bank):'-'}</td><td>${!isInc?formatMoney(item.jumlah_tunai):'-'}</td><td>${!isInc?formatMoney(item.jumlah_bank):'-'}</td><td class="text-muted">${formatMoney(bal.cash)}</td><td class="text-muted">${formatMoney(bal.bank)}</td><td class="bg-light fw-bold">${formatMoney(bal.cash + bal.bank)}</td><td class="text-center text-nowrap"><button class="btn btn-sm btn-link text-primary" onclick="openEditModal('${item.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-link text-danger" onclick="deleteTrx('${item.id}')"><i class="fas fa-trash-alt"></i></button></td></tr>`;
            });
        }

        function renderReport(data) {
            const tbody = document.querySelector('#reportTableBody'); tbody.innerHTML = '';
            let openingCash = 0, openingBank = 0, firstDate = data.length > 0 ? new Date(data[0].tarikh) : null;
            if (firstDate) {
                transactionsData.filter(t => new Date(t.tarikh) < firstDate).forEach(item => {
                    const c = parseFloat(item.jumlah_tunai || 0), b = parseFloat(item.jumlah_bank || 0);
                    if (item.jenis === 'Penerimaan') { openingCash += c; openingBank += b; } else { openingCash -= c; openingBank -= b; }
                });
            }
            tbody.innerHTML += `<tr class="text-end fw-bold table-info"><td>-</td><td>-</td><td class="text-start">BAKI B/F</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>${formatMoney(openingCash)}</td><td>${formatMoney(openingBank)}</td><td class="bg-light">${formatMoney(openingCash + openingBank)}</td></tr>`;
            let curC = openingCash, curB = openingBank, totInC=0, totInB=0, totOutC=0, totOutB=0;
            data.forEach((item, index) => {
                const isInc = item.jenis === 'Penerimaan', c = parseFloat(item.jumlah_tunai||0), b = parseFloat(item.jumlah_bank||0);
                if(isInc) { totInC+=c; totInB+=b; curC+=c; curB+=b; } else { totOutC+=c; totOutB+=b; curC-=c; curB-=b; }
                tbody.innerHTML += `<tr class="text-end"><td>${index+1}</td><td>${formatDate(item.tarikh)}</td><td class="text-start">${item.butiran}</td><td>-</td><td>${item.no_dokumen}</td><td>-</td><td>${isInc && c>0?formatMoney(c):'-'}</td><td>${isInc && b>0?formatMoney(b):'-'}</td><td>${!isInc && c>0?formatMoney(c):'-'}</td><td>${!isInc && b>0?formatMoney(b):'-'}</td><td class="fw-bold">${formatMoney(curC)}</td><td class="fw-bold">${formatMoney(curB)}</td><td class="fw-bold bg-light">${formatMoney(curC+curB)}</td></tr>`;
            });
            document.getElementById('reportTotalInCash').innerText = formatMoney(totInC); document.getElementById('reportTotalInBank').innerText = formatMoney(totInB);
            document.getElementById('reportTotalOutCash').innerText = formatMoney(totOutC); document.getElementById('reportTotalOutBank').innerText = formatMoney(totOutB);
            document.getElementById('reportFinalCash').innerText = formatMoney(curC); document.getElementById('reportFinalBank').innerText = formatMoney(curB); document.getElementById('reportFinalTotal').innerText = formatMoney(curC + curB);
            document.getElementById('reportPeriodText').innerText = `${document.getElementById('filterMonth').options[document.getElementById('filterMonth').selectedIndex].text} ${document.getElementById('filterYear').value}`;
        }

        function submitTransaction() {
            // Validasi ringkas
            if(!document.getElementById('tPartyName').value || !document.getElementById('tDate').value) {
                alert("Sila isi Nama dan Tarikh.");
                return;
            }

            toggleLoading(true);
            const formObject = { 
                jenis: document.getElementById('tType').value, 
                penerima_pembayar: document.getElementById('tPartyName').value, 
                alamat: document.getElementById('tPartyAddress').value, 
                butiran: document.getElementById('tDesc').value, 
                tarikh: document.getElementById('tDate').value, 
                jenis_dokumen: document.getElementById('tDocType').value, 
                no_dokumen: document.getElementById('tDocNo').value, 
                jumlah_tunai: parseFloat(document.getElementById('tAmountCash').value) || 0, 
                jumlah_bank: parseFloat(document.getElementById('tAmountBank').value) || 0 
            };
            
            const file = document.getElementById('tDocFile').files[0];

            // Fungsi pembantu untuk hantar data
            const sendData = (obj) => {
                google.script.run
                    .withSuccessHandler((res) => { 
                        toggleLoading(false);
                        alert(res || "Rekod berjaya disimpan."); 
                        bootstrap.Modal.getInstance(document.getElementById('modalTambah')).hide(); 
                        document.getElementById('formAddTransaction').reset(); // Reset form selepas simpan
                        loadData(); 
                    })
                    .withFailureHandler((err) => {
                        toggleLoading(false);
                        alert("Ralat Sistem: " + err.message);
                    })
                    .addTransaction(obj);
            };

            if (file) {
                const reader = new FileReader(); 
                reader.onload = function(e) {
                    formObject.fileData = e.target.result.split(',')[1]; 
                    formObject.fileName = file.name; 
                    formObject.mimeType = file.type;
                    sendData(formObject);
                }; 
                reader.onerror = () => {
                    toggleLoading(false);
                    alert("Gagal membaca fail.");
                };
                reader.readAsDataURL(file);
            } else { 
                sendData(formObject);
            }
        }

        function openEditModal(id) {
            const item = transactionsData.find(t => t.id === id); if(!item) return;
            document.getElementById('editTrxId').value = item.id; document.getElementById('eType').value = item.jenis; document.getElementById('ePartyName').value = item.penerima_pembayar;
            document.getElementById('ePartyAddress').value = item.alamat || ''; document.getElementById('eDesc').value = item.butiran; document.getElementById('eDocType').value = item.jenis_dokumen || 'Resit';
            document.getElementById('eDocNo').value = item.no_dokumen || ''; document.getElementById('eAmountCash').value = parseFloat(item.jumlah_tunai || 0).toFixed(2); document.getElementById('eAmountBank').value = parseFloat(item.jumlah_bank || 0).toFixed(2);
            document.getElementById('eDate').value = new Date(new Date(item.tarikh).getTime() - (new Date(item.tarikh).getTimezoneOffset()*60000)).toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('modalEdit')).show();
        }

        function submitUpdate() {
            toggleLoading(true);
            const formObject = { 
                id: document.getElementById('editTrxId').value, 
                jenis: document.getElementById('eType').value, 
                penerima_pembayar: document.getElementById('ePartyName').value, 
                alamat: document.getElementById('ePartyAddress').value, 
                butiran: document.getElementById('eDesc').value, 
                tarikh: document.getElementById('eDate').value, 
                jenis_dokumen: document.getElementById('eDocType').value, 
                no_dokumen: document.getElementById('eDocNo').value, 
                jumlah_tunai: parseFloat(document.getElementById('eAmountCash').value) || 0, 
                jumlah_bank: parseFloat(document.getElementById('eAmountBank').value) || 0 
            };

            google.script.run
                .withSuccessHandler((res) => { 
                    toggleLoading(false);
                    alert(res || "Rekod dikemaskini."); 
                    bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide(); 
                    loadData(); 
                })
                .withFailureHandler((err) => {
                    toggleLoading(false);
                    alert("Gagal mengemaskini: " + err.message);
                })
                .updateTransaction(formObject);
        }

        function saveAttachment() {
            const id = document.getElementById('uploadTrxId').value;
            const file = document.getElementById('newDocFile').files[0]; 
            if (!file) {
                alert("Sila pilih fail dahulu.");
                return;
            }
            
            toggleLoading(true);
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                google.script.run
                    .withSuccessHandler((res) => { 
                        toggleLoading(false);
                        alert(res); 
                        bootstrap.Modal.getInstance(document.getElementById('modalUpload')).hide(); 
                        loadData(); 
                    })
                    .withFailureHandler((err) => {
                        toggleLoading(false);
                        alert("Ralat muat naik: " + err.message);
                    })
                    .updateAttachment(id, e.target.result.split(',')[1], file.name, file.type); 
            }; 
            reader.readAsDataURL(file);
        }

        function deleteTrx(id) { if(confirm("Padam?")) { toggleLoading(true); google.script.run.withSuccessHandler(() => loadData()).deleteTransaction(id); } }
        function resetDatabase() { if(confirm("Reset?") && prompt("RESET")==='RESET') { toggleLoading(true); google.script.run.withSuccessHandler(() => loadData()).resetAllData(); } }
        function saveProfile() { toggleLoading(true); google.script.run.withSuccessHandler((msg) => { alert(msg); loadProfile(); toggleLoading(false); }).saveProfile({ nama_bank: document.getElementById('profBankName').value, no_akaun: document.getElementById('profAccNo').value }); }
        function loadProfile() { google.script.run.withSuccessHandler((d) => { if(d){ document.getElementById('profBankName').value = d.nama_bank||''; document.getElementById('profAccNo').value = d.no_akaun||''; document.getElementById('reportBankNameText').innerText = d.nama_bank||'-'; document.getElementById('reportAccNoText').innerText = d.no_akaun||'-'; } }).getProfile(); }
        function formatMoney(amount) { return parseFloat(amount).toFixed(2); }
        function formatDate(dateStr) { if(!dateStr) return '-'; const d = new Date(dateStr); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`; }
        
        // --- 100% KOD JANA PDF LAPORAN YANG ANDA BERIKAN ---
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l','mm','a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            toggleLoading(true);

            const loadImg = url => new Promise(res=>{
                const i=new Image(); i.crossOrigin="Anonymous";
                i.onload=()=>{const c=document.createElement('canvas');
                    c.width=i.width; c.height=i.height;
                    c.getContext('2d').drawImage(i,0,0);
                    res({data: c.toDataURL('image/png'), w: i.width, h: i.height});
                };
                i.onerror=()=>res(null);
                i.src=url;
            });

            const imgMajlis = await loadImg('https://i.imgur.com/eWH8KS7.png');
            const imgMasjid = await loadImg('https://i.imgur.com/1mYHNYA.jpeg');

            const logoW = 20; 
            const spacing = 10;
            const totalHeaderWidth = (logoW * 2) + spacing;
            const startXLogo = (pageWidth - totalHeaderWidth) / 2;

            if(imgMajlis) {
                const ratio = imgMajlis.h / imgMajlis.w;
                doc.addImage(imgMajlis.data, 'PNG', startXLogo, 10, logoW, logoW * ratio);
            }
            if(imgMasjid) {
                const ratio = imgMasjid.h / imgMasjid.w;
                doc.addImage(imgMasjid.data, 'JPEG', startXLogo + logoW + spacing, 10, logoW, logoW * ratio);
            }

            doc.setFontSize(14).setFont("helvetica","bold");
            doc.text("LAPORAN KEWANGAN MASJID MUKIM KUALA GRIS", pageWidth/2, 38, {align:"center"});
            doc.setLineWidth(0.5).line(20, 40, pageWidth - 20, 40);

            const year = document.getElementById('filterYear').value;
            const monthText = document.getElementById('filterMonth').options[document.getElementById('filterMonth').selectedIndex].text;
            const bankName = document.getElementById('profBankName').value || "Bank Islam Malaysia Berhad";
            const accNo = document.getElementById('profAccNo').value || "030720-10008291";

            doc.setFontSize(9).setFont("helvetica", "bold");
            let infoY = 46;
            let leftCol = 25;
            let midCol = 150;

            doc.text(`Nama Masjid:`, leftCol, infoY);
            doc.setFont("helvetica", "normal").text("Masjid Mukim Kuala Gris", leftCol + 25, infoY);
            doc.setFont("helvetica", "bold").text(`No Akaun:`, leftCol, infoY + 5);
            doc.setFont("helvetica", "normal").text(accNo, leftCol + 25, infoY + 5);
            doc.setFont("helvetica", "bold").text(`Nama Bank:`, leftCol, infoY + 10);
            doc.setFont("helvetica", "normal").text(bankName, leftCol + 25, infoY + 10);

            doc.setFont("helvetica", "bold").text(`Jajahan:`, midCol, infoY);
            doc.setFont("helvetica", "normal").text("Kuala Krai", midCol + 25, infoY);
            doc.setFont("helvetica", "bold").text(`Daerah / Negeri:`, midCol, infoY + 5);
            doc.setFont("helvetica", "normal").text("Dabong / Kelantan", midCol + 25, infoY + 5);
            doc.setFont("helvetica", "bold").text(`Bulan/Tahun:`, midCol, infoY + 10);
            doc.setFont("helvetica", "normal").text(`${monthText} ${year}`, midCol + 25, infoY + 10);

            const month = document.getElementById('filterMonth').value;
            let filteredData = transactionsData.filter(item => {
                let d = new Date(item.tarikh);
                let matchYear = d.getFullYear() == year;
                let matchMonth = month === 'all' ? true : d.getMonth() == month;
                return matchYear && matchMonth;
            });

            let bfCash = 0, bfBank = 0;
            const firstDateInFilter = filteredData.length > 0 ? new Date(filteredData[0].tarikh) : null;
            if (firstDateInFilter) {
                transactionsData.filter(t => new Date(t.tarikh) < firstDateInFilter).forEach(item => {
                    const c = parseFloat(item.jumlah_tunai || 0), b = parseFloat(item.jumlah_bank || 0);
                    if (item.jenis === 'Penerimaan') { bfCash += c; bfBank += b; } else { bfCash -= c; bfBank -= b; }
                });
            }

            let body = [];
            body.push(["-", "-", "BAKI BAWA HADAPAN", "-", "-", "-", "-", "-", formatMoney(bfCash), formatMoney(bfBank), formatMoney(bfCash + bfBank)]);

            let curC = bfCash, curB = bfBank;
            let sumInC = 0, sumInB = 0, sumOutC = 0, sumOutB = 0;

            filteredData.forEach((item, index) => {
                const isInc = item.jenis === 'Penerimaan';
                const c = parseFloat(item.jumlah_tunai || 0), b = parseFloat(item.jumlah_bank || 0);
                
                if(isInc) { 
                    curC += c; curB += b; 
                    sumInC += c; sumInB += b;
                } else { 
                    curC -= c; curB -= b; 
                    sumOutC += c; sumOutB += b;
                }
                
                body.push([
                    (index + 1).toString(),
                    formatDate(item.tarikh),
                    item.butiran,
                    item.no_dokumen || "-",
                    isInc ? formatMoney(c) : "0.00",
                    isInc ? formatMoney(b) : "0.00",
                    !isInc ? formatMoney(c) : "0.00",
                    !isInc ? formatMoney(b) : "0.00",
                    formatMoney(curC),
                    formatMoney(curB),
                    formatMoney(curC + curB)
                ]);
            });

            // Footer (Hanya akan dipaparkan di last page)
            let footer = [
                [
                    { content: 'BAKI AKHIR / JUMLAH KESELURUHAN', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(sumInC), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(sumInB), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(sumOutC), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(sumOutB), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(curC), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(curB), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatMoney(curC + curB), styles: { halign: 'right', fontStyle: 'bold', fillColor: [220, 220, 220] } }
                ]
            ];

            doc.autoTable({
                startY: 65,
                head: [
                    [
                        {content: 'Bil', rowSpan: 2, styles: {halign: 'center', valign: 'middle'}},
                        {content: 'Tarikh', rowSpan: 2, styles: {halign: 'center', valign: 'middle'}},
                        {content: 'Butir-Butir', rowSpan: 2, styles: {halign: 'center', valign: 'middle'}},
                        {content: 'No. Dok', rowSpan: 2, styles: {halign: 'center', valign: 'middle'}},
                        {content: 'Penerimaan', colSpan: 2, styles: {halign: 'center'}},
                        {content: 'Pembayaran', colSpan: 2, styles: {halign: 'center'}},
                        {content: 'Baki Akhir', colSpan: 3, styles: {halign: 'center'}}
                    ],
                    [
                        {content: 'Tunai', styles: {halign: 'center'}},
                        {content: 'Bank', styles: {halign: 'center'}},
                        {content: 'Tunai', styles: {halign: 'center'}},
                        {content: 'Bank', styles: {halign: 'center'}},
                        {content: 'Tunai', styles: {halign: 'center'}},
                        {content: 'Bank', styles: {halign: 'center'}},
                        {content: 'Jumlah', styles: {halign: 'center'}}
                    ]
                ],
                body: body,
                foot: footer,
                showFoot: 'lastPage', // KUNCI UTAMA: Hanya tunjuk baki di muka surat terakhir
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1.5, lineColor: [0, 0, 0], lineWidth: 0.1 },
                headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' },
                footStyles: { fillColor: [245, 245, 245], textColor: [0, 0, 0] },
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' },
                    1: { cellWidth: 18, halign: 'center' },
                    4: { halign: 'right' },
                    5: { halign: 'right' },
                    6: { halign: 'right' },
                    7: { halign: 'right' },
                    8: { halign: 'right' },
                    9: { halign: 'right' },
                    10: { halign: 'right' }
                }
            });

            // Tandatangan (Hanya di muka surat terakhir)
            const finalY = doc.lastAutoTable.finalY + 15;
            const signY = finalY > pageHeight - 40 ? pageHeight - 40 : finalY;

            doc.setFontSize(9).setFont("helvetica", "normal");
            doc.text("Disediakan Oleh,", 40, signY);
            doc.text("__________________________", 40, signY + 12);
            doc.text("(Bendahari)", 40, signY + 17);

            doc.text("Disahkan Oleh,", pageWidth - 80, signY);
            doc.text("__________________________", pageWidth - 80, signY + 12);
            doc.text("(Pengerusi)", pageWidth - 80, signY + 17);

            doc.save(`Laporan_Kewangan_${monthText}_${year}.pdf`);
            toggleLoading(false);
        }

        // --- FUNGSI BARU: PDF RINGKASAN DASHBOARD (PENYATUAN BUTIRAN) ---
        async function generateMonthlySummaryPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p','mm','a4'); const pageWidth = doc.internal.pageSize.getWidth(); toggleLoading(true);
            const yr = document.getElementById('filterYear').value, mIdx = document.getElementById('filterMonth').value;
            if(mIdx === 'all') { alert("Pilih bulan spesifik di 'Rekod' dahulu."); toggleLoading(false); return; }
            const mText = document.getElementById('filterMonth').options[document.getElementById('filterMonth').selectedIndex].text;

            doc.setFontSize(11).setFont("helvetica","bold").text("RINGKASAN PENYATA BULANAN KEWANGAN MASJID MUKIM KUALA GRIS", pageWidth/2, 15, {align:"center"});
            doc.text(`BULAN ${mText.toUpperCase()} ${yr}`, pageWidth/2, 20, {align:"center"});
            
            let filtered = transactionsData.filter(i => { let d = new Date(i.tarikh); return d.getFullYear() == yr && d.getMonth() == mIdx; });
            let bfC = 0, bfB = 0, fDate = filtered.length > 0 ? new Date(filtered[0].tarikh) : null;
            if(fDate) { transactionsData.filter(t => new Date(t.tarikh) < fDate).forEach(i => { if(i.jenis==='Penerimaan'){ bfC+=parseFloat(i.jumlah_tunai||0); bfB+=parseFloat(i.jumlah_bank||0); } else { bfC-=parseFloat(i.jumlah_tunai||0); bfB-=parseFloat(i.jumlah_bank||0); } }); }
            
            let totalBf = bfC + bfB;
            doc.autoTable({ startY: 28, body: [[{content: "BAKI BULAN LEPAS", styles: {halign: 'right'}}, {content: `RM ${formatMoney(totalBf)}`, styles: {halign: 'right'}}]], theme: 'plain', styles: { fontStyle: 'bold', fontSize: 10 } });

            let summaryMap = {};
            filtered.forEach(item => {
                let rawKey = (item.butiran || "Lain-lain").trim();
                let groupKey = rawKey;
                // LOGIK PENYATUAN: Satukan jika bermula dengan perkataan ini
                const groups = ["Elaun", "Aktiviti", "Penyelenggaraan", "Bil", "Tabung", "Sumbangan", "Kutipan", "Peralatan"];
                for (let g of groups) { if (rawKey.toLowerCase().startsWith(g.toLowerCase())) { groupKey = g; break; } }

                if(!summaryMap[groupKey]) summaryMap[groupKey] = { in: 0, out: 0 };
                let amt = parseFloat(item.jumlah_tunai||0) + parseFloat(item.jumlah_bank||0);
                if(item.jenis === 'Penerimaan') summaryMap[groupKey].in += amt; else summaryMap[groupKey].out += amt;
            });

            let tableRows = [], runningTotal = totalBf, rowIdx = 1;
            Object.entries(summaryMap).forEach(([name, val]) => {
                if(val.in > 0) { runningTotal += val.in; tableRows.push([rowIdx++, name, "", `RM ${formatMoney(val.in)}`, `RM ${formatMoney(runningTotal)}`]); }
                if(val.out > 0) { runningTotal -= val.out; tableRows.push([rowIdx++, name, `RM ${formatMoney(val.out)}`, "", `RM ${formatMoney(runningTotal)}`]); }
            });

            doc.autoTable({ startY: doc.lastAutoTable.finalY + 2, head: [['BIL', 'PERKARA', 'KELUAR', 'MASUK', 'JUMLAH']], body: tableRows, theme: 'grid', headStyles: { fillColor: [240, 240, 240], textColor: 0, halign: 'center' }, columnStyles: { 0: { halign: 'center' }, 2: { halign: 'right' }, 3: { halign: 'right' }, 4: { halign: 'right', fontStyle: 'bold' } } });
            doc.setFontSize(10).setFont("helvetica","bold").text(`Baki bawa ke hadapan: RM ${formatMoney(runningTotal)}`, pageWidth - 20, doc.lastAutoTable.finalY + 10, {align:"right"});
            doc.save(`Ringkasan_Dashboard_${mText}_${yr}.pdf`); toggleLoading(false);
        }
    </script>
</body>
</html>